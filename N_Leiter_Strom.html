<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <title>Elektromeister Tools</title>

    <link href="assets/fontawesome/css/all.min.css" rel="stylesheet">
    <script src="assets/jquery/jquery.js"></script>
    <script src="assets/math.min.js"></script>
    <script src="assets/mathjax/tex-svg.js"></script>
    <link href="assets/bootstrap/bootstrap.min.css" rel="stylesheet">
    <script src="assets/bootstrap/bootstrap.bundle.min.js"></script>
    <link href="assets/bootstrap_table/bootstrap-table.css" rel="stylesheet">
    <script src="assets/bootstrap_table/bootstrap-table.js"></script>
    <script src="assets/tools.js"></script>
    <script src="assets/formulartools.js"></script>
    <script src="assets/tabellen.js"></script>

</head>

<body>
    <div class="container-fluid mt-3">
        <form>
            <div class="mb-3 row">
                <div class="col-sm-1">
                    <select class="form-select" id="L1typ">
                        <option selected value="0">Ohmisch</option>
                        <option value="-1">Kapazitiv</option>
                        <option value="1">Induktiv</option>
                    </select>
                </div>
                <label for="L1cosphi" class="col-sm-1 col-form-label">L1 cos(φ)</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L1cosphi" value="1">
                </div>
                <label for="L1phi" class="col-sm-1 col-form-label">L1 Winkel φ</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L1phi" value="0">
                </div>
                <label for="L1Wirkstrom" class="col-sm-1 col-form-label">L1 Wirkstrom</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L1Wirkstrom">
                </div>
                <label for="L1Blindstrom" class="col-sm-1 col-form-label">L1 Blindstrom</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L1Blindstrom">
                </div>
                <label for="L1Scheinstrom" class="col-sm-1 col-form-label">L1 Scheinstrom</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L1Scheinstrom">
                </div>
            </div>
            <hr>
            <div class="mb-3 row">
                <div class="col-sm-1">
                    <select class="form-select" id="L2typ">
                        <option selected value="0">Ohmisch</option>
                        <option value="-1">Kapazitiv</option>
                        <option value="1">Induktiv</option>
                    </select>
                </div>
                <label for="L2cosphi" class="col-sm-1 col-form-label">L2 cos(φ)</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L2cosphi" value="1">
                </div>
                <label for="L2phi" class="col-sm-1 col-form-label">L2 Winkel φ</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L2phi" value="0">
                </div>
                <label for="L2Wirkstrom" class="col-sm-1 col-form-label">L2 Wirkstrom</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L2Wirkstrom">
                </div>
                <label for="L2Blindstrom" class="col-sm-1 col-form-label">L2 Blindstrom</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L2Blindstrom">
                </div>
                <label for="L2Scheinstrom" class="col-sm-1 col-form-label">L2 Scheinstrom</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L2Scheinstrom">
                </div>
            </div>
            <hr>
            <div class="mb-3 row">
                <div class="col-sm-1">
                    <select class="form-select" id="L3typ">
                        <option selected value="0">Ohmisch</option>
                        <option value="-1">Kapazitiv</option>
                        <option value="1">Induktiv</option>
                    </select>
                </div>
                <label for="L3cosphi" class="col-sm-1 col-form-label">L3 cos(φ)</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L3cosphi" value="1">
                </div>
                <label for="L3phi" class="col-sm-1 col-form-label">L3 Winkel φ</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L3phi" value="0">
                </div>
                <label for="L3Wirkstrom" class="col-sm-1 col-form-label">I3 Wirkstrom</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L3Wirkstrom">
                </div>
                <label for="L3Blindstrom" class="col-sm-1 col-form-label">L3 Blindstrom</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L3Blindstrom">
                </div>
                <label for="L3Scheinstrom" class="col-sm-1 col-form-label">L3 Scheinstrom</label>
                <div class="col-sm-1">
                    <input type="text" class="form-control" id="L3Scheinstrom">
                </div>
            </div>
        </form>
        <button type="button" class="btn btn-secondary" onclick="$('form').get(0).reset();Draw();">Zurücksetzen</button>
        <div class="alert alert-primary" role="alert" id="result">
        </div>

        <canvas id="canvas" width="800" height="800"></canvas>
    </div>
</body>

<script type="application/javascript">
    for (let i = 1; i < 4; i++) {
        $("#L" + i + "cosphi").change(function () {
            var oa = GetValuesFromInput(i)
            var o = CalculateAll("cosphi",oa.Iw,oa.Ib,oa.Is,oa.phi,oa.cosphi,oa.typ)
            SetInputFromValue(i,o)
            Draw()
        });

        $("#L" + i + "phi").change(function () {
            var oa = GetValuesFromInput(i)
            var o = CalculateAll("phi",oa.Iw,oa.Ib,oa.Is,oa.phi,oa.cosphi,oa.typ)
            SetInputFromValue(i,o)
            Draw()
        });

        $("#L" + i + "Scheinstrom").change(function () {
            var oa = GetValuesFromInput(i)
            var o = CalculateAll("Is",oa.Iw,oa.Ib,oa.Is,oa.phi,oa.cosphi,oa.typ)
            SetInputFromValue(i,o)
            Draw()
        });

        $("#L" + i + "Wirkstrom").change(function () {
            var oa = GetValuesFromInput(i)
            var o = CalculateAll("Iw",oa.Iw,oa.Ib,oa.Is,oa.phi,oa.cosphi,oa.typ)
            SetInputFromValue(i,o)
            Draw()
        });

        $("#L" + i + "Blindstrom").change(function () {
            var oa = GetValuesFromInput(i)
            var o = CalculateAll("Ib",oa.Iw,oa.Ib,oa.Is,oa.phi,oa.cosphi,oa.typ)
            SetInputFromValue(i,o)
            Draw()
        });

        $("#L" + i + "typ").change(function () {
            var oa = GetValuesFromInput(i)
            var o = CalculateAll("typ",oa.Iw,oa.Ib,oa.Is,oa.phi,oa.cosphi,oa.typ)
            SetInputFromValue(i,o)
            Draw()
        });

    }


    $(document).ready(function () {
          Draw()
    });

    function GetValuesFromInput(i) {
        var o={}
        o.typ = $("#L" + i + "typ").val()
        o.cosphi = $("#L" + i + "cosphi").val()
        o.phi = $("#L" + i + "phi").val()
        o.Iw = $("#L" + i + "Wirkstrom").val()
        o.Ib = $("#L" + i + "Blindstrom").val()
        o.Is = $("#L" + i + "Scheinstrom").val()
        return o
    }

    function SetInputFromValue(i,o) {
        //$("#L" + i + "typ").val(o.typ)
        if(o.cosphi!=="") {
            $("#L" + i + "cosphi").val(o.cosphi)
        }
        if(o.phi!=="") {
            $("#L" + i + "phi").val(o.phi)
        }
        if(o.Iw!=="") {
            $("#L" + i + "Wirkstrom").val(o.Iw)
        }
        if(o.Ib!=="") {
            $("#L" + i + "Blindstrom").val(o.Ib)
        }
        if(o.Is!=="") {
            $("#L" + i + "Scheinstrom").val(o.Is)
        }
    }

    function CalculateAll(changed,Iw,Ib,Is,phi,cosphi,typ) {
        var v = {}

        v.Iw = ""
        v.Ib = ""
        v.Is = ""
        v.phi = ""
        v.cosphi = ""
        v.typ = ""

        if(changed=="typ") {
            v.typ = parseFloat(typ.replace(",", "."))
            if( v.typ == 0 ) {
                cosphi = "1"
                changed = "cosphi"
            }
        }

        if(cosphi!="" && changed=="cosphi") {
            cosphi1 = parseFloat(cosphi.replace(",", "."))
            v.phi = Math.deg(Math.acos(cosphi1))
        }

        if(phi!="" && changed=="phi") {
            phi1 = parseFloat(phi.replace(",", "."))
            v.cosphi = Math.cos(Math.rad(phi1))
        }

        if(Is!="" && Iw!="" && ( changed=="Is" || changed=="Iw" ) ) {
            Is1 = parseFloat(Is.replace(",", "."))
            Iw1 = parseFloat(Iw.replace(",", "."))
            v.Ib = Math.sqrt(Is1 ** 2 - Iw1 ** 2)
        }

        if(Is!="" && Ib!="" && ( changed=="Is" || changed=="Ib" ) ) {
            Is1 = parseFloat(Is.replace(",", "."))
            Ib1 = parseFloat(Ib.replace(",", "."))
            v.Iw = Math.sqrt(Is1 ** 2 - Ib1 ** 2)
        }

        if(Ib!="" && Iw!="" && ( changed=="Ib" || changed=="Iw" ) ) {
            Iw1 = parseFloat(Iw.replace(",", "."))
            Ib1 = parseFloat(Ib.replace(",", "."))
            console.log("d1")
            v.Is = Math.sqrt(Iw1 ** 2 + Ib1 ** 2)
        }else if(phi!="" && Iw!="" && ( changed=="cosphi" || changed=="phi" || changed=="Iw" ) ) {
            Iw1 = parseFloat(Iw.replace(",", "."))
            phi1 = parseFloat(phi.replace(",", "."))
            console.log("d2")
            v.Is = Iw1 / Math.cos(Math.rad(phi1))
        }else if(phi!="" && Ib!="" && ( changed=="cosphi" ||changed=="phi" || changed=="Ib" ) ) {
            Ib1 = parseFloat(Ib.replace(",", "."))
            phi1 = parseFloat(phi.replace(",", "."))
            console.log("d3")
            v.Is = Ib1 / Math.sin(Math.rad(phi1))
        }

        return v
    }
  
    function NaNorEmpty(v) {
        if(isNaN(v) || v==="" || v==="NaN") {
            return true
        } else {
            return false
        }
    }

    function Draw() {
        var Is = []
        var phi = []
        var ready = true
        for (let i = 1; i < 4; i++) {
            // if(parseFloat($("#L" + i + "typ").val())==0) {
            $("#L" + i + "phi").prop("disabled", !Math.abs(parseFloat($("#L" + i + "typ").val())));
            $("#L" + i + "cosphi").prop("disabled", !Math.abs(parseFloat($("#L" + i + "typ").val())));
            $("#L" + i + "Blindstrom").prop("disabled", !Math.abs(parseFloat($("#L" + i + "typ").val())));
           
            Is[i] = parseFloat($("#L" + i + "Scheinstrom").val().replace(",", "."))
            phi[i] = parseFloat($("#L" + i + "phi").val().replace(",", ".")) * parseFloat($("#L" + i + "typ").val())
            if (NaNorEmpty(Is[i]) || ( Math.abs(parseFloat($("#L" + i + "typ").val())) && NaNorEmpty(phi[i]))) {
                ready = false
            }
        }

        if( ready==true ) {
            NCurrenDiagram(Is[1], phi[1], Is[2], phi[2], Is[3], phi[3])
            var N = CalcNCurrent(Is[1], phi[1], Is[2], phi[2], Is[3], phi[3]).toFixed(4)
            $("#result").text("In = " + N + " A")
        } else {
            var canvas = document.getElementById("canvas");
            if (canvas.getContext) {
                var ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            $("#result").text("In = ? A")
        }
        
        
    }

    function CalcNCurrent(I1, I1Phi, I2, I2Phi, I3, I3Phi) {
        var phi = 0.0
        var L1x = (I1 * math.sin(Math.rad(phi + 0 + I1Phi)))
        var L1y = (I1 * math.cos(Math.rad(phi + 0 + I1Phi)))
        var L2x = (I2 * math.sin(Math.rad(phi + 120 + I2Phi)))
        var L2y = (I2 * math.cos(Math.rad(phi + 120 + I2Phi)))
        var L3x = (I3 * math.sin(Math.rad(phi + 240 + I3Phi)))
        var L3y = (I3 * math.cos(Math.rad(phi + 240 + I3Phi)))
        Lx = L1x + L2x + L3x
        Ly = L1y + L2y + L3y
        var N = Math.sqrt(Lx ** 2 + Ly ** 2)
        return N
    }

    function NCurrenDiagram(I1, I1Phi, I2, I2Phi, I3, I3Phi) {
        var canvas = document.getElementById("canvas");
        if (canvas.getContext) {

            var ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            var l = 300
            var phi = 0

            Imax = Math.max(I1, I2, I3)
            l1 = l / Imax * I1
            l2 = l / Imax * I2
            l3 = l / Imax * I3

            var mx = canvas.width / 2
            var my = canvas.height / 2

            var L1x = (mx + l1 * math.sin(Math.rad(phi + 0 + I1Phi)) * -1)
            var L1y = (my + l1 * math.cos(Math.rad(phi + 0 + I1Phi)) * -1)
            var L2x = (mx + l2 * math.sin(Math.rad(phi + 120 + I2Phi)) * -1)
            var L2y = (my + l2 * math.cos(Math.rad(phi + 120 + I2Phi)) * -1)
            var L3x = (mx + l3 * math.sin(Math.rad(phi + 240 + I3Phi)) * -1)
            var L3y = (my + l3 * math.cos(Math.rad(phi + 240 + I3Phi)) * -1)
            console.log(L1x, L1y, mx, my)

            // Draw coordnate cross
            ctx.beginPath();
            ctx.strokeStyle = 'rgb(0, 0, 0)'
            ctx.moveTo(0, my);
            ctx.lineTo(canvas.width, my);
            ctx.moveTo(mx, 0);
            ctx.lineTo(mx, canvas.height);
            ctx.stroke();

            ctx.beginPath();
            ctx.strokeStyle = 'rgb(255, 0, 0)'
            ctx.lineWidth = 2;

            drawLineWithArrows(ctx, mx, my, L1x, L1y, 5, 8, false, true);
            drawLineWithArrows(ctx, mx, my, L2x, L2y, 5, 8, false, true);
            drawLineWithArrows(ctx, mx, my, L3x, L3y, 5, 8, false, true);
            ctx.lineWidth = 1;
            ctx.font = "20px monospace";
            ctx.strokeText("I L1", L1x, L1y);
            ctx.strokeText("I L2", L2x, L2y);
            ctx.strokeText("I L3", L3x, L3y);

            ctx.strokeStyle = 'rgb(0, 255, 0)'
            ctx.lineWidth = 2;
            ctx.setLineDash([20, 5]);
            drawLineWithArrows(ctx, L1x, L1y, L1x + L2x - mx, L1y + L2y - my, 5, 8, false, true, "I L2");
            drawLineWithArrows(ctx, L1x + L2x - mx, L1y + L2y - my, L1x + L2x + L3x - mx * 2, L1y + L2y + L3y - my * 2,
                5, 8, false, true, "I L3");

            ctx.strokeStyle = 'rgb(0, 0, 128)'
            ctx.fillStyle = 'rgb(0, 0, 32)'
            ctx.lineWidth = 2;
            ctx.setLineDash([]);
            drawLineWithArrows(ctx, L1x + L2x + L3x - mx * 2, L1y + L2y + L3y - my * 2, mx, my, 5, 8, false, true,
                "I Nullleiter");
            ctx.stroke();
        }
    }
</script>

</html>